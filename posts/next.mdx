---
title: Next.js åŸºæœ¬ä½¿ç”¨
date: 2021-09-09 20:23:00
description: Next.js ä»æ­å»ºåˆ°éƒ¨ç½²
---

# Next.js åŸºæœ¬ä½¿ç”¨

next.js æ˜¯åŸºäºReactçš„å‰ç«¯æ¡†æ¶ï¼Œä¸»è¦ç”¨äºæ”¯æŒé™æ€æ¸²æŸ“æˆ–æœåŠ¡ç«¯æ¸²æŸ“ã€‚

### èƒŒæ™¯

#### SPA ğŸ’†

single-page applicationï¼Œå³å•é¡µé¢åº”ç”¨ï¼Œæ˜¯ä¸€ç§ç½‘ç»œåº”ç”¨ç¨‹åºæˆ–ç½‘ç«™çš„æ¨¡å‹ï¼Œå®ƒé€šè¿‡åŠ¨æ€é‡å†™å½“å‰é¡µé¢æ¥ä¸ç”¨æˆ·äº¤äº’ï¼Œé¿å…äº†é¡µé¢ä¹‹é—´åˆ‡æ¢æ‰“æ–­ç”¨æˆ·ä½“éªŒã€‚æ‰€æœ‰å¿…è¦çš„ä»£ç ï¼ˆ`HTML`ã€`JavaScript`å’Œ`CSS`ï¼‰éƒ½é€šè¿‡å•ä¸ªé¡µé¢çš„åŠ è½½è€Œæ£€ç´¢ï¼Œæˆ–è€…æ ¹æ®éœ€è¦ï¼ˆé€šå¸¸æ˜¯ä¸ºå“åº”ç”¨æˆ·æ“ä½œï¼‰åŠ¨æ€è£…è½½é€‚å½“çš„èµ„æºå¹¶æ·»åŠ åˆ°é¡µé¢ï¼Œé¡µé¢åœ¨ä»»ä½•æ—¶é—´ç‚¹éƒ½ä¸ä¼šé‡æ–°åŠ è½½ï¼Œä¹Ÿä¸ä¼šå°†æ§åˆ¶è½¬ç§»åˆ°å…¶ä»–é¡µé¢ã€‚

##### ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹ï¼š

- ç”¨æˆ·ä½“éªŒå¥½ï¼Œé¡µé¢åˆ‡æ¢é€Ÿåº¦å¿«

- è‰¯å¥½çš„å‰åç«¯åˆ†ç¦»ï¼Œåˆ†å·¥æ˜ç¡®

ç¼ºç‚¹ï¼š

- ä¸åˆ©äºSEO

- é¦–å±æ¸²æŸ“é€Ÿåº¦è¾ƒæ…¢

#### CSR å’Œ SSR

CSRï¼šClient Side Renderï¼Œå³å®¢æˆ·ç«¯æ¸²æŸ“ï¼ŒæœåŠ¡ç«¯åªè¿”å›ä¸€ä¸ªhtmlæ¨¡æ¿ï¼Œé¡µé¢çš„å†…å®¹é€šè¿‡è¿è¡Œjsè¿è¡Œã€‚Angularã€Reactå’ŒVueæ„å»ºçš„åº”ç”¨ï¼Œé»˜è®¤éƒ½æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“ã€‚

SSRï¼šServer Side Renderï¼Œå³æœåŠ¡ç«¯æ¸²æŸ“ã€‚é¡µé¢ä¸Šçš„å†…å®¹é€šè¿‡æœåŠ¡ç«¯æ¸²æŸ“ç”Ÿæˆï¼Œç„¶åå†å°†å®Œæ•´çš„htmlè¿”å›ç»™æµè§ˆå™¨ã€‚



### å¿«é€Ÿå¼€å§‹

#### åˆ›å»ºé¡¹ç›®

ä½¿ç”¨`create-next-app`åˆ›å»ºæ–°çš„ Next.js åº”ç”¨ç¨‹åº

```bash
npx create-next-app --typescript
# or
yarn create next-app --typescript
```

#### åŸºæœ¬ç‰¹æ€§

##### é¡µé¢

åœ¨ Next.js ä¸­ï¼Œä¸€ä¸ª **pageï¼ˆé¡µé¢ï¼‰** å°±æ˜¯ä¸€ä¸ªä» `.js`ã€`jsx`ã€`.ts` æˆ– `.tsx` æ–‡ä»¶å¯¼å‡ºï¼ˆexportï¼‰çš„ [React ç»„ä»¶](https://reactjs.org/docs/components-and-props.html) ï¼Œè¿™äº›æ–‡ä»¶å­˜æ”¾åœ¨ `pages` ç›®å½•ä¸‹ã€‚æ¯ä¸ª pageï¼ˆé¡µé¢ï¼‰éƒ½ä½¿ç”¨å…¶æ–‡ä»¶åä½œä¸ºè·¯ç”±ï¼ˆrouteï¼‰ã€‚

##### è·¯ç”±

â€‹	æ–‡ä»¶ç›®å½• â†’ è·¯ç”±

- `pages/index.js`  â†’ `/`
- `pages/blog/index.js` â†’ `/blog`
- `pages/blog.js`â†’ `/blog`
- `pages/blog/[id].js`â†’ `/blog/:id`
- `pages/[username]/settings.js` â†’ `/:username/settings`
- `pages/post/[...all].js` â†’ `/post/*` (`/post/2020/id/title`)

é€šè¿‡useRouterè·å–åŠ¨æ€å‚æ•°ï¼Œå¦‚ä¸‹ï¼š

```tsx
const router = useRouter();
const { all } = router.query;
```

è·¯ç”±è·³è½¬æœ‰ä¸¤ç§æ–¹å¼ï¼Œé€šè¿‡Linkç»„ä»¶æˆ–è€…useRouter

```tsx
import Link from 'next/link'

const Post: NextPage = () => {
    ...
    return (
        <div>
            <p>{Array.isArray(all) ? all.join('/') : all}</p>
            <Link href="/blog/123"><a>blog</a></Link>
        </div>
    );
}

```

##### è·å–æ•°æ®

1. getStaticProps

ä½¿ç”¨getStaticPropsæ–¹æ³•ï¼Œnext.jsä¼šåœ¨æ‰§è¡Œ`next-build`çš„æ—¶å€™é¢„æ¸²æŸ“é¡µé¢ï¼Œå¹¶å°†getStaticPropsçš„è¿”å›ä½œä¸ºpropsä¼ ç»™ç»„ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ‰§è¡Œå®Œbuildä¹‹åï¼Œæ•°æ®å°±å˜æˆé™æ€çš„æ•°æ®äº†ã€‚

```tsx
export async function getStaticProps(context) {
    const res = await fetch(`https://service-go08i9b4-1301241041.gz.apigw.tencentcs.com/products`);
    const products = await res.json();

    if (!products) {
        return {
            notFound: true,
        }
    }

    return {
        props: { products: products as Products }, // will be passed to the page component as props
    }
}
```

2. getServerSideProps

ä½¿ç”¨getServerSidePropsæ–¹æ³•ï¼Œnext.jsä¼šåœ¨æ¯ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™å°†è¿”å›ç»“æœä½œä¸ºpropsä¼ ç»™ç»„ä»¶ã€‚ä½¿ç”¨getServerSidePropsæ¥è·å–æ•°æ®ï¼Œè™½ç„¶å‰§æœ‰å®æ—¶æ€§ï¼Œä½†æ˜¯å“åº”é€Ÿåº¦å°†æ¯”getStaticPropsæ…¢ï¼Œå› ä¸ºæ¯ä¸€æ¬¡éƒ½éœ€è¦è¯·æ±‚æ–°çš„æ•°æ®ç„¶åè®¡ç®—ç»“æœï¼Œå¹¶ä¸”ä¸èƒ½åœ¨æ²¡æœ‰é¢å¤–çš„é…ç½®ä¸‹è¢«CDNç¼“å­˜ã€‚

```js
function Page({ data }) {
  // Render data...
}

// This gets called on every request
export async function getServerSideProps() {
  // Fetch data from external API
  const res = await fetch(`https://.../data`)
  const data = await res.json()

  // Pass data to the page via props
  return { props: { data } }
}

export default Page
```

##### CSSæ”¯æŒ

1. å…¨å±€æ ·å¼

   åœ¨`pages/_app.tsx`ä¸­å¯¼å…¥cssæ–‡ä»¶ï¼ŒåŒæ ·æ”¯æŒä»`node_modules`ç›®å½•å¯¼å…¥ã€‚

   ```tsx
   import '../styles/globals.css'
   import 'bootstrap/dist/css/bootstrap.css'
   ```

   

2. ç»„ä»¶æ ·å¼

   Next.js é€šè¿‡ `[name].module.css` æ–‡ä»¶å‘½åçº¦å®šæ¥æ”¯æŒ [CSS æ¨¡å—](https://github.com/css-modules/css-modules) ã€‚

   ä¾‹å¦‚ï¼Œå‡è®¾ `components/` ç›®å½•ä¸‹æœ‰ä¸€ä¸ªå¯é‡ç”¨ `Button` ç»„ä»¶ï¼š

   é¦–å…ˆï¼Œåˆ›å»º `components/Button.module.css` æ–‡ä»¶å¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

   ```css
   .error {
     color: white;
     background-color: red;
   }
   ```

   ç„¶åï¼Œåˆ›å»º `components/Button.js` æ–‡ä»¶ï¼Œå¯¼å…¥ï¼ˆimportï¼‰å¹¶ä½¿ç”¨ä¸Šè¿° CSS æ–‡ä»¶ï¼š

   ```js
   import styles from './Button.module.css'
   
   export function Button() {
     return (
       <button
         type="button"
         // Note how the "error" class is accessed as a property on the imported
         // `styles` object.
         className={styles.error}
       >
         Destroy
       </button>
     )
   }
   ```

    å¦å¤–ï¼ŒNext.jså…è®¸å¯¼å…¥ï¼ˆimportï¼‰å…·æœ‰ `.scss` å’Œ `.sass` æ‰©å±•åçš„ Sass æ–‡ä»¶ï¼Œåªè¦ç¡®ä¿å®‰è£…äº†sassï¼Œå³å¯ä½¿ç”¨ã€‚

##### å¸¸ç”¨ç»„ä»¶

1. `next/image`

   Next.js çš„ Image ç»„ä»¶ï¼ˆå³ [`next/image`](https://www.nextjs.cn/docs/api-reference/next/image)ï¼‰æ˜¯å¯¹ HTML çš„ `<img>` å…ƒç´ çš„æ‰©å±•ï¼Œè·Ÿè¿›äº†æœ€æ–°çš„ web æŠ€æœ¯ã€‚

   è‡ªåŠ¨å›¾ç‰‡ä¼˜åŒ–åŠŸèƒ½ï¼ˆAutomatic Image Optimizationï¼‰èƒ½å¤Ÿè°ƒæ•´å›¾ç‰‡å°ºå¯¸ã€ä¼˜åŒ–å›¾ç‰‡å¹¶ä»¥æœ€æ–°çš„ [WebP](https://developer.mozilla.org/en-US/docs/Web/Media/Formats/Image_types) æ ¼å¼ä¼ è¾“å›¾ç‰‡ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒ WebP æ ¼å¼çš„è¯ï¼‰ã€‚è¿™æ ·å°±å¯ä»¥é¿å…å°†è¾ƒå¤§çš„å›¾ç‰‡ä¼ é€åˆ°è§†å£ï¼ˆviewportï¼‰è¾ƒå°çš„è®¾å¤‡ä¸Šã€‚æ­¤åŠŸèƒ½è¿˜å…è®¸ Next.js è‡ªåŠ¨é‡‡ç”¨æœªæ¥çš„å›¾ç‰‡æ ¼å¼ï¼Œå¹¶å°†å…¶ä¼ è¾“ç»™æ”¯æŒè¿™äº›æ ¼å¼çš„æµè§ˆå™¨ã€‚

   è‡ªåŠ¨å›¾ç‰‡ä¼˜åŒ–åŠŸèƒ½å¯ä»¥æ”¯æŒä»»ä½•å›¾ç‰‡æ¥æºã€‚å³ä½¿æ˜¯æ‰˜ç®¡åœ¨å¤–éƒ¨æ•°æ®æºä¸Šï¼ˆä¾‹å¦‚ï¼ŒCMSï¼‰ï¼Œä»å¯å¯¹å›¾ç‰‡è¿›è¡Œä¼˜åŒ–ã€‚

   Next.js æ— éœ€åœ¨æ„å»ºæ—¶ä¼˜åŒ–å›¾ç‰‡ï¼Œè€Œæ˜¯æ ¹æ®ç”¨æˆ·çš„è¯·æ±‚æŒ‰éœ€ä¼˜åŒ–å›¾ç‰‡ã€‚ä¸é™æ€ç«™ç‚¹ç”Ÿæˆå™¨å’Œçº¯é™æ€è§£å†³æ–¹æ¡ˆä¸åŒï¼Œæ— è®ºå‘å¸ƒ 10 å¼ è¿˜æ˜¯ 1000 ä¸‡å¼ å›¾ç‰‡ï¼Œæ„å»ºæ—¶é—´éƒ½ä¸ä¼šå¢åŠ ã€‚

   å›¾ç‰‡é»˜è®¤æ˜¯å»¶è¿ŸåŠ è½½çš„ã€‚è¿™æ„å‘³ç€ä½ çš„é¡µé¢ä¸ä¼šå› ä¸ºåŠ è½½è§†å£ï¼ˆviewportï¼‰å¤–çš„å›¾ç‰‡è€Œå½±å“é¡µé¢çš„åŠ è½½é€Ÿåº¦ã€‚å½“å›¾ç‰‡è¿›å…¥è§†å£ï¼ˆviewportï¼‰æ—¶æ‰åŠ è½½ã€‚

   å§‹ç»ˆä»¥è¿™ç§æ–¹å¼æ¸²æŸ“å›¾ç‰‡æ˜¯ä¸ºäº†é¿å… [ç´¯è®¡å¸ƒå±€åç§»ï¼ˆCumulative Layout Shiftï¼‰](https://web.dev/cls/)ï¼Œæ­¤ [Core Web Vital](https://web.dev/vitals/) è¢« Google ä½œä¸ºå‚æ•°ç”¨äº [æœç´¢æ’å](https://webmasters.googleblog.com/2020/05/evaluating-page-experience.html)ã€‚

   ä½¿ç”¨ï¼š

   ```jsx
   import Image from 'next/image'
   
   function Home() {
     return (
       <>
         <h1>My Homepage</h1>
         <Image
           src="/me.png"
           alt="Picture of the author"
           width={500}
           height={500}
         />
         <p>Welcome to my homepage!</p>
       </>
     )
   }
   
   export default Home
   ```

2. `next/head`

   ç”¨äºå°† HTML æ ‡ç­¾æ·»åŠ åˆ°é¡µé¢çš„ `head` ä¸­

   ```js
   import Head from 'next/head'
   
   function IndexPage() {
     return (
       <div>
         <Head>
           <title>My page title</title>
           <meta name="viewport" content="initial-scale=1.0, width=device-width" />
         </Head>
         <p>Hello world!</p>
       </div>
     )
   }
   
   export default IndexPage
   ```

#### é…ç½®

##### ç®€ä»‹

å¯¹äº Next.js çš„è‡ªå®šä¹‰é«˜çº§è¡Œä¸ºï¼Œå¯ä»¥åœ¨é¡¹ç›®ç›®å½•çš„æ ¹ç›®å½•ï¼ˆpackage.json æ—è¾¹ï¼‰åˆ›å»ºä¸€ä¸ª next.config.jsã€‚

`next.config.js`æ˜¯ä¸€ä¸ªNode.jsæ¨¡å—ï¼Œä¸æ˜¯ä¸€ä¸ªjsonæ–‡ä»¶ã€‚

å®šä¹‰å¦‚ä¸‹ï¼š

```js
module.exports = {
  /* config options here */
}
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå‡½æ•°ï¼š

```js
module.exports = (phase, { defaultConfig }) => {
  return {
    /* config options here */
  }
}
```

é€šè¿‡configçš„ç±»å‹å¤§æ¦‚å¯ä»¥çŸ¥é“å®ƒæ”¯æŒå“ªäº›é…ç½®ï¼š

```typescript
export declare type NextConfig = {
    [key: string]: any;
} & {
    i18n?: I18NConfig | null;
    eslint?: ESLintConfig;
    typescript?: TypeScriptConfig;
    headers?: () => Promise<Header[]>;
    rewrites?: () => Promise<Rewrite[] | {
        beforeFiles: Rewrite[];
        afterFiles: Rewrite[];
        fallback: Rewrite[];
    }>;
    redirects?: () => Promise<Redirect[]>;
    webpack5?: false;
    excludeDefaultMomentLocales?: boolean;
    webpack?: ((config: any, context: {
        dir: string;
        dev: boolean;
        isServer: boolean;
        buildId: string;
        config: NextConfigComplete;
        defaultLoaders: {
            babel: any;
        };
        totalPages: number;
        webpack: any;
    }) => any) | null;
    trailingSlash?: boolean;
    env?: {
        [key: string]: string;
    };
    distDir?: string;
    cleanDistDir?: boolean;
    assetPrefix?: string;
    useFileSystemPublicRoutes?: boolean;
    generateBuildId?: () => string | null | Promise<string | null>;
    generateEtags?: boolean;
    pageExtensions?: string[];
    compress?: boolean;
    poweredByHeader?: boolean;
    images?: ImageConfig;
    devIndicators?: {
        buildActivity?: boolean;
    };
    onDemandEntries?: {
        maxInactiveAge?: number;
        pagesBufferLength?: number;
    };
    amp?: {
        canonicalBase?: string;
    };
    basePath?: string;
    sassOptions?: {
        [key: string]: any;
    };
    productionBrowserSourceMaps?: boolean;
    optimizeFonts?: boolean;
    reactStrictMode?: boolean;
    publicRuntimeConfig?: {
        [key: string]: any;
    };
    serverRuntimeConfig?: {
        [key: string]: any;
    };
    httpAgentOptions?: {
        keepAlive?: boolean;
    };
    future?: {
        /**
         * @deprecated this options was moved to the top level
         */
        webpack5?: false;
        strictPostcssConfiguration?: boolean;
    };
    experimental?: {
        swcMinify?: boolean;
        swcLoader?: boolean;
        cpus?: number;
        sharedPool?: boolean;
        plugins?: boolean;
        profiling?: boolean;
        isrFlushToDisk?: boolean;
        reactMode?: 'legacy' | 'concurrent' | 'blocking';
        workerThreads?: boolean;
        pageEnv?: boolean;
        optimizeImages?: boolean;
        optimizeCss?: boolean;
        scrollRestoration?: boolean;
        stats?: boolean;
        externalDir?: boolean;
        conformance?: boolean;
        amp?: {
            optimizer?: any;
            validator?: string;
            skipValidation?: boolean;
        };
        reactRoot?: boolean;
        disableOptimizedLoading?: boolean;
        gzipSize?: boolean;
        craCompat?: boolean;
        esmExternals?: boolean | 'loose';
        staticPageGenerationTimeout?: number;
        isrMemoryCacheSize?: number;
        nftTracing?: boolean;
        concurrentFeatures?: boolean;
    };
};
```



#### éƒ¨ç½²

nextçš„éƒ¨ç½²ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼

##### Vercel

Vercel (ä¹‹å‰ä¹Ÿå« Zeit æˆ– now.sh) æ˜¯ä¸€å®¶æä¾›é™æ€ç½‘ç«™æ‰˜ç®¡çš„äº‘å¹³å°ï¼Œæ”¯æŒä» Github, GitLab, Bitbucket ç­‰ä»£ç ä»“åº“ä¸­è‡ªåŠ¨æ‹‰å–ä»£ç  ç„¶åè¿›è¡Œé¡¹ç›®æ‰“åŒ…å’Œéƒ¨ç½²ç­‰åŠŸèƒ½ã€‚ä½†æ˜¯å›½å†…è®¿é—®é€Ÿåº¦è¾ƒæ…¢ï¼Œåœ¨æ­¤ä¸å¤šåšä»‹ç»ã€‚

##### Node.jsæœåŠ¡

Next.js å¯ä»¥éƒ¨ç½²åˆ°ä»»ä½•æ”¯æŒ Node.js çš„æ‰˜ç®¡æä¾›å•†å¤„ã€‚

ç¡®ä¿ä½ çš„ `package.json` æ–‡ä»¶ä¸­è®¾ç½®äº† `"build"` å’Œ `"start"` è„šæœ¬ï¼š

```json
{
  "scripts": {
    "dev": "next",
    "build": "next build",
    "start": "next start"
  }
}
```

##### Docker Image

æ‰“æˆé•œåƒï¼Œå¯ä»¥éƒ¨ç½²åˆ°dockerå®¹å™¨é‡Œï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åˆ°å®¹å™¨ç¼–æ’å™¨é‡Œï¼ˆkubernetesæˆ–è€…HashiCorp Nomadï¼‰ã€‚

Dockerfileæ–‡ä»¶å‚è€ƒï¼š

```dockerfile
# Install dependencies only when needed
FROM node:alpine AS deps
# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

# Rebuild the source code only when needed
FROM node:alpine AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules
RUN yarn build && yarn install --production --ignore-scripts --prefer-offline

# Production image, copy all the files and run next
FROM node:alpine AS runner
WORKDIR /app

ENV NODE_ENV production

RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# You only need to copy next.config.js if you are NOT using the default configuration
# COPY --from=builder /app/next.config.js ./
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

USER nextjs

EXPOSE 3000

# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry.
# ENV NEXT_TELEMETRY_DISABLED 1

CMD ["yarn", "start"]
```

##### å¯¼å‡ºé™æ€æ–‡ä»¶

æ‰§è¡Œ`next build` å’Œ `next export`

ç¬¦åˆä»¥ä¸‹ä»»ä½•ä¸€é¡¹ï¼Œå°†ä¸å…è®¸ä½¿ç”¨é™æ€å¯¼å‡ºï¼š

- ä½¿ç”¨`getStaticPaths`çš„`fallback: true`æ¨¡å¼
- ä½¿ç”¨äº†`next/Image`ç»„ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨é»˜è®¤
- ä½¿ç”¨äº†`getServerSideProps`æ¥è·å–æ•°æ®
- ä½¿ç”¨å›½é™…åŒ–è·¯ç”±
- ä½¿ç”¨APIè·¯ç”±
